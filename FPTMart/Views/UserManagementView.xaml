<UserControl x:Class="FPTMart.Views.UserManagementView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <materialDesign:Card Grid.Row="0" Padding="15" Margin="0,0,0,15">
            <Grid>
                <StackPanel Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="AccountGroup" Width="24" Height="24" Foreground="#1976D2" VerticalAlignment="Center"/>
                    <TextBlock Text="Quản Lý Người Dùng" FontSize="20" FontWeight="Medium" Margin="10,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>

                <Button HorizontalAlignment="Right"
                        Command="{Binding AddUserCommand}"
                        Style="{StaticResource MaterialDesignRaisedButton}"
                        Background="#1976D2">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="Plus" VerticalAlignment="Center"/>
                        <TextBlock Text="Thêm Người Dùng" Margin="8,0,0,0"/>
                    </StackPanel>
                </Button>
            </Grid>
        </materialDesign:Card>

        <!-- Users DataGrid -->
        <materialDesign:Card Grid.Row="1" Padding="0">
            <DataGrid ItemsSource="{Binding Users}"
                      SelectedItem="{Binding SelectedUser}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      CanUserAddRows="False"
                      HeadersVisibility="Column"
                      SelectionMode="Single"
                      Background="White">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Username" Binding="{Binding Username}" Width="120"/>
                    <DataGridTextColumn Header="Họ Tên" Binding="{Binding FullName}" Width="*"/>
                    <DataGridTextColumn Header="Email" Binding="{Binding Email}" Width="200"/>
                    <DataGridTextColumn Header="SĐT" Binding="{Binding Phone}" Width="110"/>
                    <DataGridTemplateColumn Header="Role" Width="120">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <ItemsControl ItemsSource="{Binding Roles}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Orientation="Horizontal"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#E3F2FD" CornerRadius="10" Padding="8,3" Margin="0,0,5,0">
                                                <TextBlock Text="{Binding}" FontSize="11" Foreground="#1976D2"/>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTemplateColumn Header="Trạng Thái" Width="100">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border CornerRadius="10" Padding="8,3" HorizontalAlignment="Center">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Background" Value="#E8F5E9"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsActive}" Value="False">
                                                    <Setter Property="Background" Value="#FFEBEE"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <TextBlock FontSize="11">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Text" Value="Hoạt động"/>
                                                <Setter Property="Foreground" Value="#388E3C"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsActive}" Value="False">
                                                        <Setter Property="Text" Value="Vô hiệu"/>
                                                        <Setter Property="Foreground" Value="#D32F2F"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTemplateColumn Header="Thao Tác" Width="120">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <Button Style="{StaticResource MaterialDesignIconButton}"
                                            Command="{Binding DataContext.ResetPasswordCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"
                                            ToolTip="Reset mật khẩu (gửi email)">
                                        <materialDesign:PackIcon Kind="EmailSend" Foreground="#F57C00"/>
                                    </Button>
                                    <Button Style="{StaticResource MaterialDesignIconButton}"
                                            Command="{Binding DataContext.ToggleStatusCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"
                                            ToolTip="Bật/Tắt">
                                        <materialDesign:PackIcon Kind="ToggleSwitch" Foreground="#1976D2"/>
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </materialDesign:Card>

        <!-- Add User Dialog Overlay -->
        <Border Grid.RowSpan="2" 
                Background="#80000000" 
                Visibility="{Binding IsAddDialogOpen, Converter={StaticResource BooleanToVisibilityConverter}}">
            <materialDesign:Card Width="450" Padding="25" VerticalAlignment="Center" HorizontalAlignment="Center">
                <StackPanel>
                    <TextBlock Text="Thêm Người Dùng Mới" FontSize="20" FontWeight="Medium" Margin="0,0,0,10"/>
                    <TextBlock Text="Mật khẩu sẽ được tạo tự động và gửi qua email." Foreground="#666" FontSize="12" Margin="0,0,0,20"/>
                    
                    <TextBox Text="{Binding NewUsername, UpdateSourceTrigger=PropertyChanged}"
                             materialDesign:HintAssist.Hint="Tên đăng nhập *"
                             materialDesign:HintAssist.IsFloating="True"
                             Style="{StaticResource MaterialDesignOutlinedTextBox}"
                             Margin="0,0,0,15"/>
                    
                    <TextBox Text="{Binding NewFullName, UpdateSourceTrigger=PropertyChanged}"
                             materialDesign:HintAssist.Hint="Họ tên *"
                             materialDesign:HintAssist.IsFloating="True"
                             Style="{StaticResource MaterialDesignOutlinedTextBox}"
                             Margin="0,0,0,15"/>
                    
                    <TextBox Text="{Binding NewEmail, UpdateSourceTrigger=PropertyChanged}"
                             materialDesign:HintAssist.Hint="Email * (để gửi mật khẩu)"
                             materialDesign:HintAssist.IsFloating="True"
                             Style="{StaticResource MaterialDesignOutlinedTextBox}"
                             Margin="0,0,0,15"/>
                    
                    <TextBox Text="{Binding NewPhone, UpdateSourceTrigger=PropertyChanged}"
                             materialDesign:HintAssist.Hint="Số điện thoại (10 số)"
                             materialDesign:HintAssist.IsFloating="True"
                             Style="{StaticResource MaterialDesignOutlinedTextBox}"
                             Margin="0,0,0,15"/>
                    
                    <ComboBox ItemsSource="{Binding Roles}"
                              SelectedItem="{Binding SelectedRole}"
                              DisplayMemberPath="Name"
                              materialDesign:HintAssist.Hint="Chọn vai trò *"
                              materialDesign:HintAssist.IsFloating="True"
                              Style="{StaticResource MaterialDesignOutlinedComboBox}"
                              Margin="0,0,0,20"/>
                    
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Hủy" 
                                Command="{Binding CancelAddCommand}"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                Margin="0,0,10,0"/>
                        <Button Content="Tạo Tài Khoản" 
                                Command="{Binding SaveUserCommand}"
                                Style="{StaticResource MaterialDesignRaisedButton}"
                                Background="#1976D2"/>
                    </StackPanel>
                </StackPanel>
            </materialDesign:Card>
        </Border>
    </Grid>
</UserControl>
